name: Build and Test

on:
  schedule:
    - cron: '*/5 * * * *'  # Every 5 minutes
  push:
    branches:
      - develop

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the code
      - name: Checkout Code
        uses: actions/checkout@v3  # Use the latest stable version

      # Step 2: Set up JDK 11
      - name: Set up JDK 24
        uses: actions/setup-java@v3  # Use the latest stable version
        with:
          java-version: '24'
          distribution: 'temurin'

      # Step 3: Set up Playwright
      - name: Set up Playwright
        run: |
          npm install -D playwright
          npx playwright install
        env:
          PLAYWRIGHT_BROWSERS_PATH: 0
          HEADLESS: true

      # Step 4: Set JAVA_OPTS for Maven Build
      - name: Set JAVA_OPTS for Maven Build
        run: echo "JAVA_OPTS=--add-opens=jdk.compiler/com.sun.tools.javac.processing=ALL-UNNAMED" >> $GITHUB_ENV

      # Step 5: Install xvfb (X Virtual Framebuffer for headless testing)
      - name: Install xvfb (X Virtual Framebuffer)
        run: sudo apt-get install -y xvfb

      # Step 6: Run Tests with Xvfb
      - name: Run Tests with Xvfb
        run: |
          xvfb-run -a mvn clean test -Dsurefire.suiteXmlFiles=testng.xml -X

      # Step 7: Build the project with Maven
      - name: Build with Maven
        run: mvn clean install -Dmaven.compiler.source=11 -Dmaven.compiler.target=11

      # Step 8: Upload test results (update to use latest version of upload-artifact)
      - name: Upload test results
        uses: actions/upload-artifact@v2  # Reverting to a more stable version
        with:
          name: test-results
          path: target/surefire-reports/*.xml  # Adjust this to your actual test results path
